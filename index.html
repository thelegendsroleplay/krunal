<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hydraulic Dam Dashboard</title>

  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="assets/css/electrical_parameter.css">
  <link rel="stylesheet" href="assets/css/hydraulic_parameter.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <h2>ğŸŒŠ Digital Twin</h2>
    <ul>
      <li class="tab-link active" data-tab="dashboard">ğŸ“Š Dashboard</li>
      <li class="tab-link" data-tab="hydraulic">ğŸ’§ Hydraulic Data</li>
      <li class="tab-link" data-tab="electrical">âš¡ Electrical Data</li>
      <li class="logout">ğŸšª Logout</li>
    </ul>
  </aside>

  <!-- Main -->
  <main class="main-content">
    <header>
      <h1>Hydraulic Dam Control Panel</h1>
      <button id="theme-toggle">ğŸŒ—</button>
    </header>

    <!-- Dashboard -->
    <div class="tab-content active" id="dashboard">
      <section class="cards">
        <div class="card"><h3>Water Level</h3><p id="water-level">82.5 m</p></div>
        <div class="card"><h3>Flow Rate</h3><p id="flow-rate">320 mÂ³/s</p></div>
        <div class="card"><h3>Turbine Output</h3><p id="turbine-output">91%</p></div>
      </section>
      <section class="chart-section">
        <h2>Realtime Flow Trend</h2>
        <canvas id="liveChart"></canvas>
      </section>
    </div>

    <!-- Hydraulic Tab -->
    <div class="tab-content" id="hydraulic">
      <!-- Hydraulic Parameter Content -->
      <header class="top">
        <h1>ğŸ’§ Hydraulic Parameters Monitor</h1>
        <div class="actions">
          <button id="hydraulic-toggle-run">â¸ Pause</button>
          <label class="speed">
            Speed
            <select id="hydraulic-interval-ms">
              <option value="1500" selected>1.5s</option>
              <option value="1000">1.0s</option>
              <option value="500">0.5s</option>
            </select>
          </label>
          <button id="hydraulic-theme-toggle">ğŸŒ™</button>
        </div>
      </header>

      <section class="cards">
        <div class="card"><span class="label">Head (m)</span><span class="value" id="kpi-head">â€”</span></div>
        <div class="card"><span class="label">Flow (mÂ³/s)</span><span class="value" id="kpi-flow">â€”</span></div>
        <div class="card"><span class="label">Pressure (Pa)</span><span class="value" id="kpi-press">â€”</span></div>
        <div class="card"><span class="label">Efficiency (%)</span><span class="value" id="kpi-eff">â€”</span></div>
      </section>

      <section class="panel">
        <div class="panel-head"><h2>Realtime Hydraulic Trend</h2></div>
        <canvas id="liveHydraulicChart"></canvas>
      </section>

      <section class="panel">
        <div class="panel-head">
          <h2>Recent Samples</h2>
          <button id="hydraulic-clear-table" class="ghost">Clear</button>
        </div>
        <div class="table-wrap">
          <table id="hydraulicTable">
            <thead>
              <tr>
                <th>Time</th>
                <th>Head (m)</th>
                <th>Flow (mÂ³/s)</th>
                <th>Pressure (Pa)</th>
                <th>Velocity (m/s)</th>
                <th>Head Loss (m)</th>
                <th>Efficiency (%)</th>
              </tr>
            </thead>
            <tbody id="hydraulic-rows"></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- Electrical Tab -->
    <div class="tab-content" id="electrical">
      <!-- Electrical Parameter Content -->
      <header class="top">
        <h1>Generator Electrical Panel</h1>
        <div class="actions">
          <button id="electrical-toggle-run">â¸ Pause</button>
          <label class="speed">
            Speed
            <select id="electrical-interval-ms">
              <option value="1500" selected>1.5s</option>
              <option value="1000">1.0s</option>
              <option value="500">0.5s</option>
            </select>
          </label>
          <button id="electrical-theme-toggle">ğŸŒ™</button>
        </div>
      </header>

      <section class="cards">
        <div class="card"><span class="label">Voltage (V)</span><span class="value" id="kpi-voltage">â€”</span></div>
        <div class="card"><span class="label">Current (A)</span><span class="value" id="kpi-current">â€”</span></div>
        <div class="card"><span class="label">Power (kW)</span><span class="value" id="kpi-power">â€”</span></div>
        <div class="card"><span class="label">Power Factor</span><span class="value" id="kpi-pf">â€”</span></div>
        <div class="card"><span class="label">Frequency (Hz)</span><span class="value" id="kpi-freq">â€”</span></div>
      </section>

      <section class="panel">
        <div class="panel-head"><h2>Realtime Electrical Trend</h2></div>
        <canvas id="liveElecChart"></canvas>
      </section>

      <section class="panel">
        <div class="panel-head">
          <h2>Recent Samples</h2>
          <button id="electrical-clear-table" class="ghost">Clear</button>
        </div>
        <div class="table-wrap">
          <table id="electricalTable">
            <thead>
              <tr>
                <th>Record ID</th>
                <th>Voltage (V)</th>
                <th>Current (A)</th>
                <th>Power (kW)</th>
                <th>Power Factor</th>
                <th>Frequency (Hz)</th>
                <th>Timestamp</th>
              </tr>
            </thead>
            <tbody id="electrical-rows"></tbody>
          </table>
        </div>
      </section>
    </div>
  </main>

  <script src="assets/js/main.js"></script>

  <!-- Tab switching and dynamic JS loading -->
  <script>
  console.log("ğŸš€ Script loaded");

  // Store cleanup functions for each tab (globally accessible)
  window.tabCleanupFunctions = {};

  // Track which tabs have been initialized
  window.tabsInitialized = {
    hydraulic: false,
    electrical: false
  };

  document.addEventListener("DOMContentLoaded", () => {
    console.log("âœ… DOM Content Loaded");

    const tabs = document.querySelectorAll(".tab-link");
    const contents = document.querySelectorAll(".tab-content");

    console.log("ğŸ“Š Found tabs:", tabs.length);
    console.log("ğŸ“¦ Found contents:", contents.length);

    function loadTabJS(targetId, jsPath) {
      return new Promise((resolve, reject) => {
        console.log(`âš™ï¸ Loading JS for ${targetId}: ${jsPath}`);

        // Remove old script if exists
        const old = document.querySelector(`script[src*="${jsPath}"]`);
        if (old) {
          console.log("ğŸ—‘ï¸ Removing old script");
          old.remove();
        }

        const script = document.createElement("script");
        script.src = jsPath;
        script.onload = () => {
          console.log(`âœ… JS loaded: ${jsPath}`);
          window.tabsInitialized[targetId] = true;
          resolve();
        };
        script.onerror = (e) => {
          console.error(`âŒ JS error: ${jsPath}`, e);
          reject(e);
        };
        document.body.appendChild(script);
      });
    }

    tabs.forEach((tab, index) => {
      console.log(`ğŸ”— Adding listener to tab ${index}: ${tab.dataset.tab}`);

      tab.addEventListener("click", async () => {
        console.log(`ğŸ–±ï¸ Tab clicked: ${tab.dataset.tab}`);

        tabs.forEach(t => t.classList.remove("active"));
        contents.forEach(c => c.classList.remove("active"));
        tab.classList.add("active");

        const targetId = tab.dataset.tab;
        console.log(`ğŸ¯ Target ID: ${targetId}`);

        const target = document.getElementById(targetId);
        if (!target) {
          console.error(`âŒ Target element not found: #${targetId}`);
          return;
        }

        target.classList.add("active");
        console.log(`âœ… Tab activated: ${targetId}`);

        // Clean up other tabs
        Object.keys(window.tabCleanupFunctions).forEach(tabId => {
          if (tabId !== targetId && window.tabCleanupFunctions[tabId]) {
            console.log(`ğŸ§¹ Cleaning up ${tabId} tab...`);
            window.tabCleanupFunctions[tabId]();
          }
        });

        // Load tab-specific JavaScript if needed
        if (targetId === "electrical" && !window.tabsInitialized.electrical) {
          console.log("âš¡ Loading electrical parameters...");
          try {
            await loadTabJS("electrical", "assets/js/electrical_parameter.js");
          } catch (e) {
            console.error("Failed to load electrical JS:", e);
          }
        } else if (targetId === "hydraulic" && !window.tabsInitialized.hydraulic) {
          console.log("ğŸ’§ Loading hydraulic parameters...");
          try {
            await loadTabJS("hydraulic", "assets/js/hydraulic_parameter.js");
          } catch (e) {
            console.error("Failed to load hydraulic JS:", e);
          }
        } else {
          console.log(`â„¹ï¸ No dynamic loading for: ${targetId}`);
        }
      });
    });

    console.log("âœ… All tab listeners added");
  });
  </script>
</body>
</html>
