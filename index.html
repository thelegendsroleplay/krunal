<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hydraulic Dam Dashboard</title>

  <link rel="stylesheet" href="assets/css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <h2>ğŸŒŠ Digital Twin</h2>
    <ul>
      <li class="tab-link active" data-tab="dashboard">ğŸ“Š Dashboard</li>
      <li class="tab-link" data-tab="hydraulic">ğŸ’§ Hydraulic Data</li>
      <li class="tab-link" data-tab="electrical">âš¡ Electrical Data</li>
      <li class="logout">ğŸšª Logout</li>
    </ul>
  </aside>

  <!-- Main -->
  <main class="main-content">
    <header>
      <h1>Hydraulic Dam Control Panel</h1>
      <button id="theme-toggle">ğŸŒ—</button>
    </header>

    <!-- Dashboard -->
    <div class="tab-content active" id="dashboard">
      <section class="cards">
        <div class="card"><h3>Water Level</h3><p id="water-level">82.5 m</p></div>
        <div class="card"><h3>Flow Rate</h3><p id="flow-rate">320 mÂ³/s</p></div>
        <div class="card"><h3>Turbine Output</h3><p id="turbine-output">91%</p></div>
      </section>
      <section class="chart-section">
        <h2>Realtime Flow Trend</h2>
        <canvas id="liveChart"></canvas>
      </section>
    </div>

    <!-- Dynamic Tabs -->
    <div class="tab-content" id="hydraulic"></div>
    <div class="tab-content" id="electrical"></div>
  </main>

  <script src="assets/js/main.js"></script>

  <!-- Dynamic loader with DEBUG -->
  <script>
  console.log("ğŸš€ Script loaded");

  document.addEventListener("DOMContentLoaded", () => {
    console.log("âœ… DOM Content Loaded");

    const tabs = document.querySelectorAll(".tab-link");
    const contents = document.querySelectorAll(".tab-content");

    console.log("ğŸ“Š Found tabs:", tabs.length);
    console.log("ğŸ“¦ Found contents:", contents.length);

    async function loadTab(targetId, htmlPath, cssPath, jsPath) {
      console.log(`ğŸ”„ Loading tab: ${targetId}`);
      console.log(`ğŸ“„ HTML path: ${htmlPath}`);
      console.log(`ğŸ¨ CSS path: ${cssPath}`);
      console.log(`âš™ï¸ JS path: ${jsPath}`);

      try {
        console.log(`â³ Fetching: ${htmlPath}`);
        const res = await fetch(htmlPath);
        console.log(`âœ… Fetch response status: ${res.status}`);

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }

        const html = await res.text();
        console.log(`ğŸ“ HTML loaded, length: ${html.length} chars`);

        const targetElement = document.getElementById(targetId);
        if (!targetElement) {
          console.error(`âŒ Target element not found: ${targetId}`);
          return;
        }

        targetElement.innerHTML = html;
        console.log(`âœ… HTML injected into #${targetId}`);

        // Load CSS
        if (!document.querySelector(`link[href^="${cssPath}"]`)) {
          console.log(`ğŸ¨ Loading CSS: ${cssPath}`);
          const link = document.createElement("link");
          link.rel = "stylesheet";
          // Add cache-busting query parameter
          link.href = cssPath + '?v=' + Date.now();
          document.head.appendChild(link);
          console.log("âœ… CSS link added");
        } else {
          console.log("â„¹ï¸ CSS already loaded");
        }

        // Load JS
        const old = document.querySelector(`script[src^="${jsPath}"]`);
        if (old) {
          console.log("ğŸ—‘ï¸ Removing old script");
          old.remove();
        }

        console.log(`âš™ï¸ Loading JS: ${jsPath}`);
        const script = document.createElement("script");
        // Add cache-busting query parameter
        script.src = jsPath + '?v=' + Date.now();
        script.defer = true;
        script.onload = () => console.log(`âœ… JS loaded: ${jsPath}`);
        script.onerror = (e) => console.error(`âŒ JS error: ${jsPath}`, e);
        document.body.appendChild(script);

      } catch (e) {
        console.error(`âŒ Error loading tab ${targetId}:`, e);
        const targetElement = document.getElementById(targetId);
        if (targetElement) {
          targetElement.innerHTML = `<p style='color:red; padding:20px;'>Failed to load: ${e.message}</p>`;
        }
      }
    }

    tabs.forEach((tab, index) => {
      console.log(`ğŸ”— Adding listener to tab ${index}: ${tab.dataset.tab}`);

      tab.addEventListener("click", async () => {
        console.log(`ğŸ–±ï¸ Tab clicked: ${tab.dataset.tab}`);

        tabs.forEach(t => t.classList.remove("active"));
        contents.forEach(c => c.classList.remove("active"));
        tab.classList.add("active");

        const targetId = tab.dataset.tab;
        console.log(`ğŸ¯ Target ID: ${targetId}`);

        const target = document.getElementById(targetId);
        if (!target) {
          console.error(`âŒ Target element not found: #${targetId}`);
          return;
        }

        target.classList.add("active");
        console.log(`âœ… Tab activated: ${targetId}`);

        if (targetId === "electrical") {
          console.log("âš¡ Loading electrical parameters...");
          await loadTab(
            "electrical",
            "electrical_parameter.html",
            "assets/css/electrical_parameter.css",
            "assets/js/electrical_parameter.js"
          );
        } else if (targetId === "hydraulic") {
          console.log("ğŸ’§ Loading hydraulic parameters...");
          await loadTab(
            "hydraulic",
            "hydraulic_parameter.html",
            "assets/css/hydraulic_parameter.css",
            "assets/js/hydraulic_parameter.js"
          );
        } else {
          console.log(`â„¹ï¸ No dynamic loading for: ${targetId}`);
        }
      });
    });

    console.log("âœ… All tab listeners added");
  });
  </script>
</body>
</html>
